<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logs & Audit Trail - Smart Attendance</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Kanit:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="styles.css">
    <style>
        .sidebar {
            width: 280px;
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            background: white;
            border-right: 1px solid #e5e7eb;
            overflow-y: auto;
            z-index: 50;
        }

        .sidebar-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 20px;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
            text-decoration: none;
        }

        .sidebar-item.active {
            background: #eff6ff;
            color: #3b82f6;
            border-left-color: #3b82f6;
        }

        .main-content {
            margin-left: 280px;
            min-height: 100vh;
            background: #f9fafb;
        }
    </style>
</head>

<body class="bg-gray-50">
    <aside class="sidebar">
        <div class="p-6 border-b">
            <h2 class="text-lg font-bold font-kanit">Admin Panel</h2>
        </div>
        <nav class="py-4">
            <a href="admin-dashboard.html" class="sidebar-item"><span>üìä</span><span
                    class="font-kanit">Dashboard</span></a>
            <a href="admin-academic-year.html" class="sidebar-item"><span>üìÖ</span><span
                    class="font-kanit">‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</span></a>
            <a href="admin-students.html" class="sidebar-item"><span>üë•</span><span
                    class="font-kanit">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span></a>
            <a href="admin-teachers.html" class="sidebar-item"><span>üë®‚Äçüè´</span><span class="font-kanit">‡∏Ñ‡∏£‡∏π</span></a>
            <a href="admin-users.html" class="sidebar-item"><span>üîê</span><span class="font-kanit">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ &
                    ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</span></a>
            <a href="admin-classes.html" class="sidebar-item"><span>üè´</span><span
                    class="font-kanit">‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span></a>
            <a href="admin-subjects.html" class="sidebar-item"><span>üìö</span><span
                    class="font-kanit">‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</span></a>
            <a href="admin-timetable.html" class="sidebar-item"><span>üóìÔ∏è</span><span
                    class="font-kanit">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span></a>
            <a href="admin-attendance.html" class="sidebar-item"><span>üìä</span><span
                    class="font-kanit">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span></a>
            <a href="admin-warnings.html" class="sidebar-item"><span>‚ö†Ô∏è</span><span
                    class="font-kanit">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</span></a>
            <a href="admin-reports.html" class="sidebar-item"><span>üìÑ</span><span class="font-kanit">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</span></a>
            <a href="admin-logs.html" class="sidebar-item active"><span>üìú</span><span
                    class="font-kanit">Logs</span></a>
            <a href="admin-settings.html" class="sidebar-item"><span>‚öôÔ∏è</span><span
                    class="font-kanit">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</span></a>
            <a href="admin-backup.html" class="sidebar-item"><span>üíæ</span><span class="font-kanit">‡∏™‡∏≥‡∏£‡∏≠‡∏á</span></a>
        </nav>
    </aside>

    <main class="main-content">
        <div class="p-6">
            <h1 class="text-3xl font-bold font-kanit mb-6">üìú System Logs & Audit Trail</h1>

            <!-- Filters -->
            <div class="bg-white p-4 rounded-lg shadow-md mb-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°:</label>
                        <input type="date" id="filterDateStart" class="w-full px-4 py-2 rounded-lg border">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î:</label>
                        <input type="date" id="filterDateEnd" class="w-full px-4 py-2 rounded-lg border">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</label>
                        <select id="filterType" class="w-full px-4 py-2 rounded-lg border">
                            <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                            <option value="LOGIN">Login/Logout</option>
                            <option value="ATTENDANCE">Attendance</option>
                            <option value="STUDENT">Student Mgmt</option>
                            <option value="TEACHER">Teacher Mgmt</option>
                            <option value="SETTING">Settings Change</option>
                            <option value="BACKUP">Backup/Restore</option>
                            <option value="OVERRIDE">Admin Override</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ:</label>
                        <input type="text" id="filterUser" placeholder="Username..."
                            class="w-full px-4 py-2 rounded-lg border">
                    </div>
                </div>
                <div class="mt-4 flex gap-2">
                    <button onclick="loadLogs()" class="px-6 py-2 bg-blue-500 text-white rounded-lg font-kanit">üîç
                        ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                    <button onclick="resetFilters()" class="px-6 py-2 bg-gray-500 text-white rounded-lg font-kanit">üîÑ
                        ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
                    <button onclick="exportLogs()" class="px-6 py-2 bg-green-500 text-white rounded-lg font-kanit">üì•
                        Export</button>
                </div>
            </div>

            <!-- Logs Table -->
            <div class="bg-white rounded-lg shadow-md overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="text-left py-4 px-6 font-kanit">Timestamp</th>
                            <th class="text-left py-4 px-6 font-kanit">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</th>
                            <th class="text-left py-4 px-6 font-kanit">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                            <th class="text-left py-4 px-6 font-kanit">‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥</th>
                            <th class="text-left py-4 px-6 font-kanit">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
                            <th class="text-left py-4 px-6 font-kanit">IP Address</th>
                        </tr>
                    </thead>
                    <tbody id="logsTable">
                        <tr>
                            <td colspan="6" class="text-center py-8 text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td>
                        </tr>
                    </tbody>
                </table>
                <div class="p-4 flex justify-between items-center border-t">
                    <div class="text-sm text-gray-600">‡πÅ‡∏™‡∏î‡∏á <span id="logCount">0</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
                    <div class="flex gap-2" id="pagination"></div>
                </div>
            </div>
        </div>
    </main>

    <script src="app.js"></script>
    <script>
        let allLogs = [];
        let currentPage = 1;
        const pageSize = 50;

        document.addEventListener('DOMContentLoaded', async function () {
            if (!Session.requireAuth(['ADMIN'])) return;
            initFilters();
            await loadLogs();
        });

        function initFilters() {
            const today = new Date();
            const weekAgo = new Date(today);
            weekAgo.setDate(weekAgo.getDate() - 7);

            document.getElementById('filterDateStart').valueAsDate = weekAgo;
            document.getElementById('filterDateEnd').valueAsDate = today;
        }

        async function loadLogs() {
            Utils.showLoader();
            try {
                const filters = {
                    dateStart: document.getElementById('filterDateStart').value,
                    dateEnd: document.getElementById('filterDateEnd').value,
                    type: document.getElementById('filterType').value,
                    user: document.getElementById('filterUser').value
                };

                const result = await API.getLogs(filters);
                if (result.success) {
                    allLogs = result.data;
                    currentPage = 1;
                    renderLogs();
                }
            } catch (error) {
                console.error('Error:', error);
            }
            Utils.hideLoader();
        }

        function renderLogs() {
            const tbody = document.getElementById('logsTable');
            if (allLogs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ logs</td></tr>';
                document.getElementById('logCount').textContent = '0';
                return;
            }

            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            const pageLogs = allLogs.slice(start, end);

            tbody.innerHTML = pageLogs.map(log => `
                <tr class="border-b">
                    <td class="py-4 px-6 font-mono text-sm">${log.Timestamp}</td>
                    <td class="py-4 px-6">${log.Username || '-'}</td>
                    <td class="py-4 px-6">
                        <span class="px-3 py-1 rounded-full text-sm ${getTypeColor(log.Type)}">
                            ${log.Type}
                        </span>
                    </td>
                    <td class="py-4 px-6">${log.Action}</td>
                    <td class="py-4 px-6 text-sm text-gray-600">${log.Details || '-'}</td>
                    <td class="py-4 px-6 font-mono text-sm">${log.IPAddress || '-'}</td>
                </tr>
            `).join('');

            document.getElementById('logCount').textContent = allLogs.length;
            renderPagination();
        }

        function getTypeColor(type) {
            const colors = {
                'LOGIN': 'bg-blue-100 text-blue-800',
                'ATTENDANCE': 'bg-green-100 text-green-800',
                'STUDENT': 'bg-purple-100 text-purple-800',
                'TEACHER': 'bg-indigo-100 text-indigo-800',
                'SETTING': 'bg-orange-100 text-orange-800',
                'BACKUP': 'bg-pink-100 text-pink-800',
                'OVERRIDE': 'bg-red-100 text-red-800'
            };
            return colors[type] || 'bg-gray-100 text-gray-800';
        }

        function renderPagination() {
            const totalPages = Math.ceil(allLogs.length / pageSize);
            const paginationDiv = document.getElementById('pagination');

            if (totalPages <= 1) {
                paginationDiv.innerHTML = '';
                return;
            }

            let html = '';
            for (let i = 1; i <= totalPages; i++) {
                const active = i === currentPage ? 'bg-blue-500 text-white' : 'bg-white text-gray-700';
                html += `<button onclick="goToPage(${i})" class="px-4 py-2 rounded ${active}">${i}</button>`;
            }
            paginationDiv.innerHTML = html;
        }

        function goToPage(page) {
            currentPage = page;
            renderLogs();
        }

        function resetFilters() {
            initFilters();
            document.getElementById('filterType').value = '';
            document.getElementById('filterUser').value = '';
        }

        function exportLogs() {
            Utils.showNotification('‡∏Å‡∏≥‡∏•‡∏±‡∏á Export Logs...', 'info');
            // Export logic with CSV/Excel
        }

        function logout() { Session.clear(); window.location.href = 'index.html'; }
    </script>
</body>

</html>