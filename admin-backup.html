<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏™‡∏≥‡∏£‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• - Smart Attendance</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Kanit:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="styles.css">
    <style>
        .sidebar {
            width: 280px;
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            background: white;
            border-right: 1px solid #e5e7eb;
            overflow-y: auto;
            z-index: 50;
        }

        .sidebar-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 20px;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
            text-decoration: none;
        }

        .sidebar-item.active {
            background: #eff6ff;
            color: #3b82f6;
            border-left-color: #3b82f6;
        }

        .main-content {
            margin-left: 280px;
            min-height: 100vh;
            background: #f9fafb;
        }
    </style>
</head>

<body class="bg-gray-50">
    <aside class="sidebar">
        <div class="p-6 border-b">
            <h2 class="text-lg font-bold font-kanit">Admin Panel</h2>
        </div>
        <nav class="py-4">
            <a href="admin-dashboard.html" class="sidebar-item"><span>üìä</span><span
                    class="font-kanit">Dashboard</span></a>
            <a href="admin-academic-year.html" class="sidebar-item"><span>üìÖ</span><span
                    class="font-kanit">‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</span></a>
            <a href="admin-students.html" class="sidebar-item"><span>üë•</span><span
                    class="font-kanit">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span></a>
            <a href="admin-teachers.html" class="sidebar-item"><span>üë®‚Äçüè´</span><span class="font-kanit">‡∏Ñ‡∏£‡∏π</span></a>
            <a href="admin-users.html" class="sidebar-item"><span>üîê</span><span class="font-kanit">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ &
                    ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</span></a>
            <a href="admin-classes.html" class="sidebar-item"><span>üè´</span><span
                    class="font-kanit">‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span></a>
            <a href="admin-subjects.html" class="sidebar-item"><span>üìö</span><span
                    class="font-kanit">‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</span></a>
            <a href="admin-timetable.html" class="sidebar-item"><span>üóìÔ∏è</span><span
                    class="font-kanit">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span></a>
            <a href="admin-attendance.html" class="sidebar-item"><span>üìä</span><span
                    class="font-kanit">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span></a>
            <a href="admin-warnings.html" class="sidebar-item"><span>‚ö†Ô∏è</span><span
                    class="font-kanit">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</span></a>
            <a href="admin-reports.html" class="sidebar-item"><span>üìÑ</span><span class="font-kanit">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</span></a>
            <a href="admin-logs.html" class="sidebar-item"><span>üìú</span><span class="font-kanit">Logs</span></a>
            <a href="admin-settings.html" class="sidebar-item"><span>‚öôÔ∏è</span><span
                    class="font-kanit">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</span></a>
            <a href="admin-backup.html" class="sidebar-item active"><span>üíæ</span><span
                    class="font-kanit">‡∏™‡∏≥‡∏£‡∏≠‡∏á</span></a>
        </nav>
    </aside>

    <main class="main-content">
        <div class="p-6">
            <h1 class="text-3xl font-bold font-kanit mb-6">üíæ ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h1>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Create Backup -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-bold font-kanit mb-4">üì¶ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡∏£‡∏≠‡∏á</h2>

                    <div class="mb-4">
                        <p class="text-sm text-gray-600 mb-4">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏≠‡∏á:</p>

                        <div class="space-y-2">
                            <label
                                class="flex items-center gap-2 p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" id="backupStudents" checked class="backup-checkbox">
                                <span>üë• ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (<span id="studentsCount">0</span> ‡∏Ñ‡∏ô)</span>
                            </label>

                            <label
                                class="flex items-center gap-2 p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" id="backupTeachers" checked class="backup-checkbox">
                                <span>üë®‚Äçüè´ ‡∏Ñ‡∏£‡∏π (<span id="teachersCount">0</span> ‡∏Ñ‡∏ô)</span>
                            </label>

                            <label
                                class="flex items-center gap-2 p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" id="backupClasses" checked class="backup-checkbox">
                                <span>üè´ ‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (<span id="classesCount">0</span> ‡∏´‡πâ‡∏≠‡∏á)</span>
                            </label>

                            <label
                                class="flex items-center gap-2 p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" id="backupSubjects" checked class="backup-checkbox">
                                <span>üìö ‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤ (<span id="subjectsCount">0</span> ‡∏ß‡∏¥‡∏ä‡∏≤)</span>
                            </label>

                            <label
                                class="flex items-center gap-2 p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" id="backupAttendance" checked class="backup-checkbox">
                                <span>üìä ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (<span id="attendanceCount">0</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</span>
                            </label>

                            <label
                                class="flex items-center gap-2 p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" id="backupTimetable" checked class="backup-checkbox">
                                <span>üóìÔ∏è ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span>
                            </label>

                            <label
                                class="flex items-center gap-2 p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" id="backupSettings" checked class="backup-checkbox">
                                <span>‚öôÔ∏è ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</span>
                            </label>
                        </div>
                    </div>

                    <div class="mb-6">
                        <label class="block text-sm font-medium mb-2">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Attendance:</label>
                        <div class="grid grid-cols-2 gap-2">
                            <input type="date" id="backupDateStart" class="px-4 py-2 rounded-lg border">
                            <input type="date" id="backupDateEnd" class="px-4 py-2 rounded-lg border">
                        </div>
                    </div>

                    <button onclick="createBackup()"
                        class="w-full px-6 py-3 bg-blue-500 text-white rounded-lg font-kanit font-bold">
                        üíæ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡∏£‡∏≠‡∏á
                    </button>
                </div>

                <!-- Restore Backup -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-bold font-kanit mb-4">‚ôªÔ∏è ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>

                    <div class="mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <p class="text-sm text-yellow-800">‚ö†Ô∏è <strong>‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô:</strong>
                            ‡∏Å‡∏≤‡∏£‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô</p>
                    </div>

                    <div class="mb-6">
                        <label class="block text-sm font-medium mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡∏£‡∏≠‡∏á (JSON):</label>
                        <input type="file" id="restoreFile" accept=".json" class="w-full px-4 py-2 rounded-lg border">
                    </div>

                    <div class="mb-6" id="restorePreview" style="display: none;">
                        <h3 class="font-bold mb-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡∏£‡∏≠‡∏á:</h3>
                        <div class="text-sm space-y-1" id="restorePreviewContent"></div>
                    </div>

                    <button onclick="restoreBackup()"
                        class="w-full px-6 py-3 bg-green-500 text-white rounded-lg font-kanit font-bold">
                        ‚ôªÔ∏è ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </button>
                </div>
            </div>

            <!-- Backup History -->
            <div class="bg-white p-6 rounded-lg shadow-md mt-6">
                <h2 class="text-xl font-bold font-kanit mb-4">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏≠‡∏á</h2>

                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="text-left py-3 px-4 font-kanit">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á</th>
                            <th class="text-left py-3 px-4 font-kanit">‡∏ú‡∏π‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á</th>
                            <th class="text-left py-3 px-4 font-kanit">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏£‡∏≠‡∏á</th>
                            <th class="text-center py-3 px-4 font-kanit">‡∏Ç‡∏ô‡∏≤‡∏î</th>
                            <th class="text-center py-3 px-4 font-kanit">‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody id="historyTable">
                        <tr>
                            <td colspan="5" class="text-center py-8 text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏≠‡∏á</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Auto Backup Settings -->
            <div class="bg-white p-6 rounded-lg shadow-md mt-6">
                <h2 class="text-xl font-bold font-kanit mb-4">üîÑ ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="flex items-center gap-2 mb-4">
                            <input type="checkbox" id="enableAutoBackup">
                            <span>‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</span>
                        </label>

                        <div id="autoBackupSettings" style="display: none;">
                            <label class="block text-sm font-medium mb-2">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà:</label>
                            <select id="autoBackupFrequency" class="w-full px-4 py-2 rounded-lg border mb-4">
                                <option value="daily">‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏∑‡∏ô)</option>
                                <option value="weekly">‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå (‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå)</option>
                                <option value="monthly">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 1)</option>
                            </select>

                            <label class="block text-sm font-medium mb-2">‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡∏£‡∏≠‡∏á:</label>
                            <select id="autoBackupRetention" class="w-full px-4 py-2 rounded-lg border">
                                <option value="7">7 ‡πÑ‡∏ü‡∏•‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</option>
                                <option value="14">14 ‡πÑ‡∏ü‡∏•‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</option>
                                <option value="30">30 ‡πÑ‡∏ü‡∏•‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</option>
                            </select>
                        </div>
                    </div>

                    <div class="p-4 bg-blue-50 rounded-lg">
                        <h3 class="font-bold mb-2">üí° ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</h3>
                        <ul class="text-sm space-y-1 text-gray-700">
                            <li>‚Ä¢ ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</li>
                            <li>‚Ä¢ ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡∏£‡∏≠‡∏á‡πÑ‡∏ß‡πâ‡∏ö‡∏ô Google Drive ‡∏´‡∏£‡∏∑‡∏≠ Cloud</li>
                            <li>‚Ä¢ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡∏£‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥</li>
                            <li>‚Ä¢ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</li>
                        </ul>
                    </div>
                </div>

                <button onclick="saveAutoBackupSettings()"
                    class="mt-4 px-6 py-3 bg-blue-500 text-white rounded-lg font-kanit">
                    üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
                </button>
            </div>
        </div>
    </main>

    <script src="app.js"></script>
    <script>
        let backupData = null;

        document.addEventListener('DOMContentLoaded', async function () {
            if (!Session.requireAuth(['ADMIN'])) return;
            await loadCounts();
            await loadHistory();

            document.getElementById('enableAutoBackup').addEventListener('change', function () {
                document.getElementById('autoBackupSettings').style.display = this.checked ? 'block' : 'none';
            });

            document.getElementById('restoreFile').addEventListener('change', handleFileSelect);
        });

        async function loadCounts() {
            try {
                const [students, teachers, classes, subjects, attendance] = await Promise.all([
                    API.getStudents(),
                    API.getTeachers(),
                    API.getClasses(),
                    API.getSubjects(),
                    API.getAttendance({})
                ]);

                if (students.success) document.getElementById('studentsCount').textContent = students.data.length;
                if (teachers.success) document.getElementById('teachersCount').textContent = teachers.data.length;
                if (classes.success) document.getElementById('classesCount').textContent = classes.data.length;
                if (subjects.success) document.getElementById('subjectsCount').textContent = subjects.data.length;
                if (attendance.success) document.getElementById('attendanceCount').textContent = attendance.data.length;
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function loadHistory() {
            try {
                const result = await API.getBackupHistory();
                if (result.success) {
                    renderHistory(result.data);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function renderHistory(history) {
            const tbody = document.getElementById('historyTable');
            if (history.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏≠‡∏á</td></tr>';
                return;
            }

            tbody.innerHTML = history.map(h => `
                <tr class="border-b">
                    <td class="py-3 px-4">${h.Date}</td>
                    <td class="py-3 px-4">${h.CreatedBy}</td>
                    <td class="py-3 px-4">${h.Tables.join(', ')}</td>
                    <td class="text-center py-3 px-4">${h.Size} KB</td>
                    <td class="text-center py-3 px-4">
                        <button onclick="downloadBackup('${h.ID}')" class="px-3 py-1 bg-blue-500 text-white rounded text-sm">‚¨áÔ∏è ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</button>
                    </td>
                </tr>
            `).join('');
        }

        async function createBackup() {
            const tables = [];
            if (document.getElementById('backupStudents').checked) tables.push('Students');
            if (document.getElementById('backupTeachers').checked) tables.push('Teachers');
            if (document.getElementById('backupClasses').checked) tables.push('Classes');
            if (document.getElementById('backupSubjects').checked) tables.push('Subjects');
            if (document.getElementById('backupAttendance').checked) tables.push('Attendance');
            if (document.getElementById('backupTimetable').checked) tables.push('Timetable');
            if (document.getElementById('backupSettings').checked) tables.push('Settings');

            if (tables.length === 0) {
                Utils.showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏≠‡∏á', 'error');
                return;
            }

            Utils.showLoader();
            try {
                const result = await API.createBackup({
                    tables,
                    dateStart: document.getElementById('backupDateStart').value,
                    dateEnd: document.getElementById('backupDateEnd').value
                });

                if (result.success) {
                    backupData = result.data;

                    // Download as JSON
                    const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `backup_${new Date().toISOString().split('T')[0]}.json`;
                    a.click();

                    Utils.showNotification('‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                    await loadHistory();
                }
            } catch (error) {
                console.error('Error:', error);
            }
            Utils.hideLoader();
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    backupData = JSON.parse(e.target.result);

                    const preview = document.getElementById('restorePreview');
                    const content = document.getElementById('restorePreviewContent');

                    let html = '';
                    for (const table in backupData) {
                        if (Array.isArray(backupData[table])) {
                            html += `<div>‚úÖ ${table}: ${backupData[table].length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>`;
                        }
                    }

                    content.innerHTML = html;
                    preview.style.display = 'block';
                } catch (error) {
                    Utils.showNotification('‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
                }
            };
            reader.readAsText(file);
        }

        async function restoreBackup() {
            if (!backupData) {
                Utils.showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô', 'error');
                return;
            }

            const confirmation = prompt('‡∏û‡∏¥‡∏°‡∏û‡πå "RESTORE" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà)');
            if (confirmation !== 'RESTORE') return;

            Utils.showLoader();
            try {
                const result = await API.restoreBackup(backupData);
                if (result.success) {
                    Utils.showNotification('‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤', 'success');
                    setTimeout(() => window.location.reload(), 2000);
                }
            } catch (error) {
                console.error('Error:', error);
            }
            Utils.hideLoader();
        }

        async function downloadBackup(id) {
            Utils.showLoader();
            try {
                const result = await API.getBackupFile(id);
                if (result.success) {
                    const blob = new Blob([JSON.stringify(result.data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `backup_${id}.json`;
                    a.click();
                    Utils.showNotification('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                }
            } catch (error) {
                console.error('Error:', error);
            }
            Utils.hideLoader();
        }

        async function saveAutoBackupSettings() {
            const data = {
                enabled: document.getElementById('enableAutoBackup').checked,
                frequency: document.getElementById('autoBackupFrequency').value,
                retention: document.getElementById('autoBackupRetention').value
            };

            Utils.showLoader();
            try {
                const result = await API.saveSettings({ type: 'autoBackup', data });
                if (result.success) {
                    Utils.showNotification('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                }
            } catch (error) {
                console.error('Error:', error);
            }
            Utils.hideLoader();
        }

        function logout() { Session.clear(); window.location.href = 'index.html'; }
    </script>
</body>

</html>